# توثيق مشروع نظام المحاسبة الزراعية

## 1. وصف التطبيق ونظرة عامة

**نظام المحاسبة الزراعية** هو تطبيق سطح مكتب شامل مصمم خصيصًا لإدارة الجوانب المالية والتشغيلية للأنشطة الزراعية وتجارة المحاصيل. البرنامج موجه باللغة العربية ويوفر مجموعة واسعة من الميزات التي تتيح للمستخدمين تتبع وإدارة حساباتهم بكفاءة ودقة.

### الميزات الوظيفية الرئيسية:

*   **إدارة العمليات اليومية:** تسجيل المبيعات، المشتريات، والمصروفات بسهولة.
*   **دفتر اليومية:** عرض مركزي لجميع الحركات المالية (مبيعات، مشتريات، مصروفات، مدفوعات) مع إمكانية البحث والتصفية.
*   **إدارة المخزون:** تتبع دقيق لكميات المخزون من كل محصول، مع تحديثات تلقائية بناءً على عمليات البيع والشراء والمرتجعات.
*   **إدارة البيانات الأساسية:**
    *   **جهات التعامل:** إدارة قائمة العملاء والموردين.
    *   **المحاصيل:** تعريف المحاصيل التي يتم التعامل بها وتحديد وحدات التسعير الخاصة بها.
    *   **الحسابات المالية:** إنشاء وإدارة شجرة الحسابات (خزنة، بنوك، أصول، خصوم...).
    *   **المواسم الزراعية:** تعريف المواسم لتصنيف العمليات المتعلقة بكل موسم.
*   **التقارير والتحليل:** يوفر التطبيق مركزًا للتقارير لإنشاء تقارير مالية هامة مثل قائمة الدخل، الميزانية العمومية، وكشوف الحساب.
*   **الأسعار اليومية:** ميزة متقدمة لتسجيل أسعار السوق اليومية للمحاصيل.

---

## 2. الخريطة التقنية والهيكلية العامة (Code Map)

يتبع المشروع **هيكلية متعددة الطبقات (Multi-tiered Architecture)** متقدمة، تعتمد على نمط التصميم **Model-View-Controller (MVC)** مع فصل واضح للمسؤوليات لضمان أقصى درجات التنظيم والقابلية للصيانة.

```
/src
└── /main
    ├── /java
    │   ├── /accounting
    │   │   ├── /gui         -> (View) نقطة انطلاق التطبيق
    │   │   ├── /controller  -> (Controller) متحكمات الواجهات
    │   │   ├── /service     -> (Business Logic) طبقة الخدمات ومنطق العمل
    │   │   ├── /dao         -> (Data Access) طبقة الوصول للبيانات
    │   │   ├── /util        -> أدوات مساعدة (مدير قاعدة البيانات، المدققات)
    │   │   ├── /model       -> كائنات ونماذج البيانات
    │   │   └── /component   -> مكونات واجهة مستخدم مخصصة
    │   └── module-info.java -> تعريف وحدة Java
    │
    └── /resources
        ├── /css           -> (View) ملفات الأنماط
        ├── /fxml          -> (View) ملفات تصميم الواجهات
        └── /fonts         -> الخطوط المخصصة
```

### وصف المكونات الرئيسية:

*   **View (طبقة العرض):**
    *   **الموقع:** `src/main/resources/fxml`, `.../css`, `src/main/java/accounting/gui`.
    *   **التقنية:** **JavaFX** و **FXML**.
    *   **الوصف:** هي كل ما يراه المستخدم. تتكون من ملفات FXML التي تعرف هيكل الواجهات، وملفات CSS للأنماط، والفئة الرئيسية `ImprovedAccountingApp.java` التي تبدأ التطبيق.

*   **Controller (طبقة التحكم):**
    *   **الموقع:** `src/main/java/accounting/controller/`
    *   **الوصف:** تعمل هذه الطبقة كوسيط بين واجهة المستخدم ومنطق العمل. لكل ملف FXML، يوجد Controller مقابل يستقبل أوامر المستخدم (مثل نقرات الأزرار)، ويقوم بالتحقق المبدئي من البيانات، ثم يستدعي الخدمات المناسبة من طبقة `Service`.

*   **Service (طبقة الخدمات):**
    *   **الموقع:** `src/main/java/accounting/service/`
    *   **الوصف:** هذه الطبقة هي **عقل التطبيق الحقيقي**. تحتوي على كل منطق العمل والمنطق المحاسبي المعقد. على سبيل المثال، `SaleDataService.java` يحتوي على دالة `addSale` التي لا تقوم فقط بحفظ سجل البيع، بل تقوم أيضًا بحساب تكلفة البضاعة المباعة، وإنشاء جميع القيود المحاسبية المزدوجة اللازمة، وتحديث المخزون، وكل ذلك داخل معاملة (Transaction) واحدة لضمان سلامة البيانات.

*   **DAO (طبقة الوصول للبيانات):**
    *   **الموقع:** `src/main/java/accounting/dao/`
    *   **الوصف:** توفر هذه الطبقة تجريدًا (abstraction) لعمليات قاعدة البيانات الأساسية (CRUD - Create, Read, Update, Delete). الفئة `AbstractDAO` توفر تطبيقًا عامًا يمكن للـ DAOs الأخرى أن ترث منه، مما يقلل من تكرار الكود.

*   **Util (الأدوات المساعدة):**
    *   **الموقع:** `src/main/java/accounting/util/`
    *   **الوصف:** تحتوي هذه الحزمة على فئات مساعدة مهمة، أهمها `ImprovedDataManager.java` الذي يدير اتصال قاعدة البيانات باستخدام `HikariCP` ويوفر وظيفة `executeTransaction` الحيوية التي تستخدمها طبقة الخدمات لضمان تكامل البيانات.

*   **Model (نماذج البيانات):**
    *   **الموقع:** `src/main/java/accounting/model/`
    *   **الوصف:** تحتوي على فئات Java بسيطة (POJOs) تمثل الكيانات في قاعدة البيانات (مثل `Crop.java`, `SaleRecord.java`).

### المكتبات والتقنيات المستخدمة:

*   **Java 21:** إصدار اللغة المستخدم.
*   **JavaFX:** إطار العمل الأساسي لبناء واجهة المستخدم.
*   **Maven:** أداة إدارة المشروع والاعتماديات.
*   **SQLite:** محرك قاعدة البيانات المدمجة.
*   **HikariCP:** مكتبة لإدارة تجميع اتصالات قاعدة البيانات (Connection Pooling) لتحقيق أداء عالٍ.
*   **SLF4J:** واجهة برمجية لتوثيق الأحداث (Logging).
*   **Ikonli:** مكتبة لإضافة أيقونات (FontAwesome) بسهولة في واجهات JavaFX.
*   **Gson:** لمعالجة وتحويل كائنات Java إلى JSON والعكس.
*   **JUnit 5:** إطار عمل الاختبارات.

---

## 3. تسلسل بدء تشغيل التطبيق

1.  **`ImprovedAccountingApp.main()`:** نقطة الدخول الرئيسية للتطبيق.
2.  **`ImprovedAccountingApp.start()`:**
    *   يتم تحميل الخطوط المخصصة (`Cairo`).
    *   يتم تحميل ملف الواجهة الرئيسي `main.fxml` باستخدام `FXMLLoader`.
    *   يتم إنشاء `Scene` وتطبيق ملف الأنماط `application.css` عليها.
    *   يتم عرض النافذة الرئيسية (`Stage`).
3.  **`MainController.initialize()`:**
    *   بمجرد تحميل `main.fxml`، يتم استدعاء هذه الدالة في المتحكم الرئيسي.
    *   تقوم بتعيين اتجاه الواجهة ليكون من اليمين إلى اليسار (`RTL`).
    *   تقوم بتحميل الواجهة الافتراضية (دفتر اليومية `JournalView.fxml`) في منطقة المحتوى الرئيسية.
    *   تبدأ مؤقتًا لتحديث عرض التاريخ والوقت في شريط الحالة كل ثانية.

---

## 4. هيكل قاعدة البيانات

يتم تعريف وإنشاء قاعدة البيانات بالكامل عبر الكود في ملف `ImprovedDataManager.java`. هذا يضمن أن هيكل قاعدة البيانات صحيح دائمًا عند تشغيل التطبيق.

### الجداول الرئيسية:

*   `crops`: لتخزين معلومات المحاصيل.
*   `contacts`: لتخزين معلومات العملاء والموردين.
*   `financial_accounts`: شجرة الحسابات.
*   `purchases`: سجل عمليات الشراء.
*   `sales`: سجل عمليات البيع.
*   `inventory`: لتتبع المخزون الحالي لكل محصول.
*   `general_ledger`: دفتر الأستاذ العام الذي يسجل جميع القيود المحاسبية (مدين ودائن).
*   `financial_transactions`: سجل الحركات المالية على الحسابات.
*   `payments`: لتسجيل الدفعات المستلمة والمدفوعة.
*   `seasons`: لإدارة المواسم الزراعية.
*   `daily_prices`: لتتبع أسعار السوق اليومية.
*   `audit_log`: سجل تدقيق لتتبع التغييرات على البيانات.

يتم استخدام **فهارس (Indexes)** على الجداول الرئيسية لضمان سرعة الاستعلام والبحث.

### إدارة البيانات:

*   يتم استخدام **Singleton Pattern** في `ImprovedDataManager` لضمان وجود مثيل واحد فقط لإدارة قاعدة البيانات.
*   يتم استخدام **Connection Pooling (HikariCP)** لتجنب تكلفة فتح وإغلاق الاتصالات بشكل متكرر.
*   يتم توفير دالة `executeTransaction` لضمان تنفيذ العمليات المعقدة (مثل إنشاء فاتورة بيع وتحديث المخزون وتسجيل قيد محاسبي) كوحدة واحدة (Transaction)، مما يضمن سلامة البيانات.

---

## 5. طبقة الوصول إلى البيانات (DAO Pattern)

لزيادة تنظيم الكود وفصل المسؤوليات بشكل أفضل، يستخدم التطبيق نمط **Data Access Object (DAO)**. الهدف من هذا النمط هو توفير واجهة مجردة للتواصل مع قاعدة البيانات، بحيث يتم إخفاء تفاصيل كيفية تنفيذ استعلامات SQL عن طبقة الخدمات (Service Layer).

### 5.1. الفئة المجردة `AbstractDAO`

*   **الموقع:** `src/main/java/accounting/dao/AbstractDAO.java`
*   **الغرض:** توفر هذه الفئة تطبيقًا عامًا (Generic) لمعظم عمليات قاعدة البيانات القياسية (CRUD: Create, Read, Update, Delete). هذا يعني أن أي فئة DAO خاصة بكيان معين (مثل `CropDAO` أو `ContactDAO`) لا تحتاج إلى إعادة كتابة منطق `findById` أو `findAll` من الصفر.
*   **آلية العمل:**
    1.  ترث الفئات المتخصصة (مثل `SaleDataService`) من `AbstractDAO`.
    2.  تقوم كل فئة متخصصة بتطبيق الدوال المجردة التي تعرف كيفية تحويل `ResultSet` إلى كائن Java (`mapResultSetToEntity`) وكيفية تحويل كائن Java إلى `PreparedStatement` للحفظ أو التحديث.
    3.  بهذه الطريقة، يتم كتابة منطق SQL الفعلي مرة واحدة فقط في الفئة المتخصصة، بينما يتم التعامل مع إدارة الاتصالات وتنفيذ الاستعلامات بواسطة `AbstractDAO`.

هذا النهج لا يقلل من تكرار الكود فحسب، بل يجعل أيضًا طبقة الخدمات (`Service Layer`) أنظف وأكثر تركيزًا على منطق العمل بدلاً من تفاصيل الوصول إلى البيانات.

---

## 6. الخلاصة والتوصيات

هذا المشروع مبني على أسس هندسية قوية ويتبع أفضل الممارسات في تطوير تطبيقات JavaFX. الفصل الواضح بين المكونات، واستخدام أدوات احترافية مثل Maven و HikariCP، والهيكلية المنظمة لقاعدة البيانات تجعل من السهل على أي مطور جديد فهم الكود والمساهمة فيه.

**الخطوة التالية المقترحة:**
البدء في **المرحلة الثانية** من التوثيق: اختيار وحدة معينة (مثل "إدارة المبيعات") وتوثيقها بالتفصيل.

---

## 6. الوحدة الأولى: إدارة البيانات الأساسية (Core Data Management)

هذه الوحدة هي حجر الأساس للتطبيق بأكمله. لا يمكن تسجيل أي معاملة مالية (بيع، شراء، مصروف) دون أن تكون البيانات المتعلقة بها (مثل المحاصيل، العملاء، الموردين، الحسابات المالية) مُعرفة مسبقًا. تتكون هذه الوحدة من أربعة أجزاء رئيسية.

### 6.1. إدارة المحاصيل (Crop Management)

*   **الغرض:** تعريف المحاصيل التي يتعامل بها النشاط، وتحديد وحدات القياس المختلفة لكل محصول ومعاملات التحويل إلى الكيلوجرام.
*   **تدفق المستخدم:**
    1.  ينتقل المستخدم إلى شاشة "إدارة المحاصيل" من القائمة الجانبية.
    2.  تظهر له شاشة `CropManagement.fxml` التي تعرض جدولاً بالمحاصيل الموجودة.
    3.  يمكن للمستخدم الضغط على "إضافة محصول" لفتح نافذة منبثقة (`CropForm.fxml`).
    4.  في هذه النافذة، يُدخل المستخدم اسم المحصول ويضيف وحدات القياس (مثل: أردب = 150 كجم، قنطار = 50 كجم).
    5.  عند الحفظ، يتم استدعاء `CropDataService` لحفظ البيانات في جدول `crops` في قاعدة البيانات.

*   **الملفات الرئيسية:**
    *   **View:** `CropManagement.fxml`, `CropForm.fxml`
    *   **Controller:** `CropManagementController.java`, `CropFormController.java`
    *   **Model:** `Crop.java`
    *   **Service:** `CropDataService.java`

*   **منطق إضافي:**
    *   `CropDataService` يستخدم مكتبة `Gson` لتحويل قائمة الوحدات وعوامل التحويل إلى نص بصيغة JSON لتخزينها في حقل واحد في قاعدة البيانات، مما يوفر مرونة عالية.
    *   عند حذف محصول، يتم استخدام الحذف الناعم (Soft Delete) عن طريق تحديث حقل `is_active` إلى `0` بدلاً من الحذف الفعلي، للحفاظ على سلامة البيانات التاريخية.

### 6.2. إدارة جهات التعامل (Contact Management)

*   **الغرض:** تعريف العملاء والموردين الذين يتعامل معهم النشاط.
*   **تدفق المستخدم:**
    1.  من القائمة الجانبية، يختار المستخدم "جهات التعامل".
    2.  شاشة `ContactManagement.fxml` تعرض جدولاً بجميع جهات التعامل مع إمكانية التصفية (الكل، عملاء، موردون) والبحث.
    3.  عند إضافة أو تعديل جهة تعامل، تظهر نافذة `ContactForm.fxml`.
    4.  يُدخل المستخدم البيانات الأساسية ويحدد ما إذا كانت جهة التعامل "عميل" و/أو "مورد".
    5.  عند الحفظ، يقوم `ContactFormController` بجمع البيانات وتمريرها إلى `ContactManagementController` الذي يستدعي بدوره `ContactDataService` لحفظها.

*   **الملفات الرئيسية:**
    *   **View:** `ContactManagement.fxml`, `ContactForm.fxml`
    *   **Controller:** `ContactManagementController.java`, `ContactFormController.java`
    *   **Model:** `Contact.java`
    *   **Service:** `ContactDataService.java`

*   **منطق إضافي:**
    *   يحتوي `ContactManagementController` على منطق لفتح شاشة "كشف حساب" (`ContactStatementView.fxml`) خاصة بجهة التعامل المحددة.

### 6.3. إدارة الحسابات المالية (Financial Account Management)

*   **الغرض:** بناء شجرة الحسابات التي تشكل أساس النظام المحاسبي (مثل: الخزنة، حسابات البنوك، حسابات المصروفات، رأس المال، إلخ).
*   **تدفق المستخدم:**
    1.  يختار المستخدم "الحسابات المالية" من القائمة الجانبية.
    2.  تعرض شاشة `FinancialAccountManagement.fxml` جدولاً بالحسابات الحالية وأرصدتها.
    3.  عند إضافة حساب جديد (`FinancialAccountForm.fxml`)، يحدد المستخدم اسم الحساب، ونوعه (من قائمة `AccountType` المنسدلة)، والرصيد الافتتاحي وتاريخه.
    4.  `FinancialAccountDataService` يتولى حفظ الحساب في جدول `financial_accounts`.

*   **الملفات الرئيسية:**
    *   **View:** `FinancialAccountManagement.fxml`, `FinancialAccountForm.fxml`
    *   **Controller:** `FinancialAccountManagementController.java`, `FinancialAccountFormController.java`
    *   **Model:** `FinancialAccount.java` (يحتوي على `enum` مهم جدًا لأنواع الحسابات `AccountType`).
    *   **Service:** `FinancialAccountDataService.java`

*   **منطق إضافي:**
    *   يتم إنشاء مجموعة من الحسابات الافتراضية (شجرة الحسابات الأساسية) تلقائيًا عند أول تشغيل للتطبيق من خلال دالة `createDefaultAccounts` في `ImprovedDataManager.java`.

### 6.4. إدارة المواسم (Season Management)

*   **الغرض:** تعريف المواسم الزراعية أو فترات زمنية محددة لتجميع وتحليل المعاملات التي تحدث خلالها.
*   **تدفق المستخدم:**
    1.  يختار المستخدم "المواسم" من القائمة الجانبية.
    2.  تعرض شاشة `SeasonManagement.fxml` المواسم المعرفة وحالتها (قادم، نشط، مكتمل).
    3.  يمكن للمستخدم إضافة موسم جديد عبر `SeasonForm.fxml` بتحديد اسمه وتاريخ بدايته ونهايته وحالته.
    4.  `SeasonDataService` يقوم بحفظ البيانات في جدول `seasons`.

*   **الملفات الرئيسية:**
    *   **View:** `SeasonManagement.fxml`, `SeasonForm.fxml`
    *   **Controller:** `SeasonManagementController.java`, `SeasonFormController.java`
    *   **Model:** `Season.java`
    *   **Service:** `SeasonDataService.java`

*   **منطق إضافي:**
    *   يمكن ربط المعاملات (المبيعات والمشتريات) بموسم معين، مما يسمح لاحقًا باستخراج تقارير أداء خاصة بكل موسم على حدة.

---

## 7. الوحدة الثانية: دورة المشتريات والمبيعات (Purchases & Sales Workflow)

هذه الوحدة هي المحرك الأساسي للتطبيق، حيث تسجل العمليات التجارية اليومية التي تؤثر مباشرة على كل من المخزون والوضع المالي للنشاط. تم تصميم هذه الوحدة بعناية لضمان **التكامل المحاسبي**، حيث أن كل عملية بيع أو شراء هي معاملة متكاملة (Transaction) تضمن تحديث جميع السجلات المترابطة معًا أو عدم تحديث أي منها على الإطلاق.

### 7.1. دورة عمل المشتريات (Purchasing Workflow)

*   **الغرض:** تسجيل فواتير المشتريات من الموردين، وتحديث المخزون بالكميات الواردة، وتسجيل الالتزامات المالية (الذمم الدائنة).
*   **تدفق المستخدم:**
    1.  يفتح المستخدم شاشة "سجل المشتريات" (`PurchaseHistoryView.fxml`) ويرى قائمة بالفواتير السابقة.
    2.  يضغط على "فاتورة شراء جديدة"، فتظهر له نافذة `PurchaseForm.fxml` التي تعمل بنظام المساعد الذكي (Wizard) المكون من 3 خطوات.
    3.  **الخطوة 1 (البيانات الأساسية):** يختار المورد، المحصول، تاريخ ورقم الفاتورة.
    4.  **الخطوة 2 (الكمية والتكاليف):** يُدخل الكمية بالكيلوجرام وسعر الوحدة (مثل سعر الأردب). يقوم النظام تلقائيًا بحساب التكلفة الإجمالية.
    5.  **الخطوة 3 (الدفع والمراجعة):** يُدخل المبلغ المدفوع (إن وجد) ويختار طريقة الدفع (نقدي أو بنكي)، ثم يراجع ملخص الفاتورة ويحفظها.

*   **الملفات الرئيسية:**
    *   **View:** `PurchaseHistoryView.fxml`, `PurchaseForm.fxml`
    *   **Controller:** `PurchaseHistoryController.java`, `PurchaseFormController.java`
    *   **Model:** `PurchaseRecord.java`
    *   **Service:** `PurchaseDataService.java`

*   **المنطق المحاسبي المتكامل (في `PurchaseDataService.addPurchaseLogic`):**
    تتم جميع الخطوات التالية داخل معاملة (`Transaction`) واحدة لضمان سلامة البيانات:
    1.  **إضافة سجل الشراء:** يتم إضافة سجل أساسي في جدول `purchases`.
    2.  **تسجيل قيد اليومية (القيد المزدوج):** يقوم `PurchaseDataService` باستدعاء `ImprovedDataManager.addLedgerEntry` مرتين لتسجيل القيد المحاسبي الصحيح:
        *   **مدين:** حساب المخزون (زيادة في الأصول).
        *   **دائن:** حساب الذمم الدائنة (زيادة في الالتزامات).
    3.  **تسجيل دفعة السداد (إن وجدت):** إذا تم دفع جزء من المبلغ، يتم تسجيل قيد إضافي لتخفيض الالتزام مقابل نقص النقدية.
    4.  **تحديث أرصدة الحسابات:** يتم استدعاء `ImprovedDataManager.updateAccountBalance` لتحديث الأرصدة الإجمالية لجميع الحسابات المتأثرة.
    5.  **تحديث المخزون:** أخيرًا، يتم استدعاء `ImprovedDataManager.updateInventory` لزيادة كمية المخزون وتحديث متوسط التكلفة.

### 7.2. دورة عمل المبيعات (Sales Workflow)

*   **الغرض:** تسجيل فواتير المبيعات للعملاء، وتخفيض المخزون، وتسجيل الإيرادات والمستحقات (الذمم المدينة).
*   **تدفق المستخدم:** مشابه تمامًا لدورة المشتريات، حيث يستخدم `SaleForm.fxml` المساعد الذكي لإدخال بيانات فاتورة البيع على 3 خطوات.

*   **الملفات الرئيسية:**
    *   **View:** `SaleHistoryView.fxml`, `SaleForm.fxml`
    *   **Controller:** `SaleHistoryController.java`, `SaleFormController.java`
    *   **Model:** `SaleRecord.java`
    *   **Service:** `SaleDataService.java`

*   **المنطق المحاسبي المتكامل (في `SaleDataService.addSaleLogic`):**
    تتم جميع الخطوات التالية داخل معاملة (`Transaction`) واحدة لضمان سلامة البيانات:
    1.  **إضافة سجل البيع:** يتم إضافة سجل أساسي في جدول `sales`.
    2.  **حساب تكلفة البضاعة المباعة (COGS):** تقوم الخدمة بجلب متوسط تكلفة المحصول من المخزون.
    3.  **تسجيل قيد اليومية (4 أطراف):** يتم تسجيل قيدين مزدوجين في `general_ledger`:
        *   **قيد إثبات الإيراد:** (مدين: الذمم المدينة، دائن: إيرادات المبيعات).
        *   **قيد إثبات التكلفة:** (مدين: تكلفة البضاعة المباعة، دائن: المخزون).
    4.  **تسجيل دفعة التحصيل (إن وجدت):** يتم تسجيل قيد لتحصيل النقدية مقابل تخفيض الذمم المدينة.
    5.  **تحديث أرصدة الحسابات:** يتم تحديث أرصدة جميع الحسابات المتأثرة.
    6.  **تحديث المخزون:** يتم استدعاء `ImprovedDataManager.updateInventory` لتخفيض كمية المخزون.

### 7.3. أهمية المعاملات المتكاملة (Transactional Integrity)

إن أهم ما يميز هذه الوحدة هو أن جميع الخطوات المحاسبية المذكورة أعلاه لكل من البيع والشراء تتم داخل دالة `dataManager.executeTransaction`. هذا يضمن أنه إذا فشلت أي خطوة من الخطوات (على سبيل المثال، فشل تحديث المخزون)، فسيتم التراجع عن جميع الخطوات السابقة (Rollback) تلقائيًا. هذا يمنع حدوث أخطاء في البيانات ويضمن أن تكون السجلات المحاسبية متوافقة ومتكاملة دائمًا.

---

## 8. الوحدة الثالثة: إدارة المخزون (Inventory Management)

تعتبر وحدة المخزون محورية في التطبيق، حيث أنها لا تعرض فقط الكميات المتاحة، بل تتأثر مباشرة بعمليات البيع والشراء وتسمح بالتعديلات اليدوية اللازمة لتعكس الواقع الفعلي.

### 8.1. عرض حالة المخزون

*   **الغرض:** توفير نظرة شاملة وسريعة على حالة المخزون لجميع المحاصيل، بما في ذلك الكمية الحالية، متوسط التكلفة، والقيمة الإجمالية للمخزون.
*   **تدفق المستخدم:**
    1.  ينتقل المستخدم إلى شاشة "المخزون" من القائمة الجانبية.
    2.  تقوم شاشة `Inventory.fxml` بالتحميل، ويستدعي `InventoryController` دالة `cropDataService.getAllCropStatistics()` لجلب بيانات المخزون المجمعة لكل محصول.
    3.  يتم عرض كل محصول في "بطاقة مخزون" (`Inventory Card`) منفصلة، تحتوي على اسم المحصول، الكمية المتاحة، متوسط التكلفة، والقيمة الإجمالية.
    4.  يتم عرض القيمة الإجمالية لكل المخزون في أسفل الشاشة.

*   **الملفات الرئيسية:**
    *   **View:** `Inventory.fxml`
    *   **Controller:** `InventoryController.java`
    *   **Service:** `CropDataService.java` (تحديدًا دالة `getAllCropStatistics`).

### 8.2. تسويات المخزون (Inventory Adjustments)

*   **الغرض:** معالجة الفروقات بين المخزون الفعلي والمخزون المسجل في النظام بسبب التلف، العجز، أو الزيادة المفاجئة.
*   **تدفق المستخدم:**
    1.  من شاشة "المخزون"، يضغط المستخدم على زر "تسوية مخزون".
    2.  تظهر نافذة `InventoryAdjustmentView.fxml`.
    3.  يختار المستخدم المحصول، تاريخ التسوية، نوع التسوية (تالف، عجز، زيادة)، والكمية بالكيلوجرام.
    4.  عند الحفظ، يتم استدعاء دالة `cropDataService.addInventoryAdjustment(adjustment)`.

*   **الملفات الرئيسية:**
    *   **View:** `InventoryAdjustmentView.fxml`
    *   **Controller:** `InventoryAdjustmentController.java`
    *   **Model:** `InventoryAdjustment.java`
    *   **Service:** `CropDataService.java` (تحديدًا دالة `addInventoryAdjustment`).

*   **المنطق المحاسبي المتكامل (في `addInventoryAdjustment`):**
    هذه العملية أيضًا تتم داخل معاملة متكاملة (`executeTransaction`) لضمان الدقة المحاسبية:
    1.  **حساب التكلفة:** يتم حساب تكلفة الكمية المعدلة بناءً على متوسط التكلفة الحالي للمحصول في المخزون.
    2.  **إضافة سجل التسوية:** يتم حفظ تفاصيل العملية في جدول `inventory_adjustments`.
    3.  **تسجيل قيد اليومية:** يتم تسجيل قيد محاسبي مزدوج في `general_ledger` يعكس الأثر المالي للتسوية:
        *   **في حالة التلف/العجز:**
            *   **مدين:** حساب "خسائر المخزون" (مصروف).
            *   **دائن:** حساب "المخزون" (أصل).
        *   **في حالة الزيادة:**
            *   **مدين:** حساب "المخزون" (أصل).
            *   **دائن:** حساب "أرباح فروقات المخزون" (إيراد).
    4.  **تحديث أرصدة الحسابات:** يتم تحديث أرصدة الحسابات المتأثرة (المخزون، خسائر المخزون، أرباح فروقات المخزون).
    5.  **تحديث كمية المخزون:** يتم استدعاء `ImprovedDataManager.updateInventory` لتحديث الكمية الفعلية في جدول `inventory`.

### 8.3. التحديث التلقائي للمخزون

من المهم ملاحظة أن المخزون لا يتم تحديثه فقط من خلال التسويات اليدوية. كما هو موضح في **الوحدة الثانية**، فإن أي عملية **شراء** تؤدي إلى زيادة تلقائية في المخزون، وأي عملية **بيع** تؤدي إلى نقص تلقائي في المخزون. هذا التكامل يضمن أن رصيد المخزون يعكس دائمًا العمليات التجارية التي تم تسجيلها في النظام.

---

## 9. الوحدة الرابعة: دفتر اليومية المركزي (The Central Journal)

يعتبر دفتر اليومية (`JournalView.fxml`) هو القلب النابض للتطبيق، حيث يعرض سجلاً تاريخياً لجميع الحركات المالية التي تم تسجيلها في النظام. إنه ليس مجرد واجهة لعرض البيانات، بل هو أيضًا مركز تحكم للوصول السريع إلى إنشاء العمليات المختلفة.

### 9.1. الغرض والهيكلية

*   **الغرض:** توفير شاشة موحدة للمستخدم لمراجعة جميع المعاملات المالية (مبيعات، مشتريات، مصروفات، تسويات، مدفوعات) بترتيب زمني، مع إمكانية البحث والتصفية المتقدمة.
*   **هيكلية العرض:** يتم عرض البيانات في جدول يوضح التاريخ، البيان، المبلغ الوارد (مدين)، المبلغ الصادر (دائن)، والرصيد المرحل. كما توجد بطاقات إحصائية في الأعلى تلخص رصيد أول المدة، إجمالي الوارد، إجمالي الصادر، والرصيد الختامي للفترة المحددة.

*   **الملفات الرئيسية:**
    *   **View:** `JournalView.fxml`
    *   **Controller:** `JournalViewController.java`
    *   **Service:** `FinancialTransactionDataService.java` (تحديدًا دالة `getCashFlowEntries`).

### 9.2. مصدر البيانات

على عكس الوحدات الأخرى التي تكتب بياناتها الخاصة، فإن دفتر اليومية هو وحدة **للقراءة فقط** بمعنى أنها **تجمع** البيانات من مصادر متعددة. المصدر الرئيسي للبيانات المعروضة هو جدول `general_ledger`. يقوم `FinancialTransactionDataService` بتجميع القيود من هذا الجدول وتنسيقها في شكل تدفقات نقدية (`CashFlowEntry`) لعرضها في الواجهة.

### 9.3. دورة عمل المصروفات (Expense Workflow)

تعتبر المصروفات جزءًا أساسيًا من البيانات التي تظهر في دفتر اليومية.

*   **الغرض:** تسجيل المصروفات النثرية أو التشغيلية التي لا ترتبط مباشرة بفواتير شراء (مثل: أجور عمال، كهرباء، وقود).
*   **تدفق المستخدم:**
    1.  يضغط المستخدم على زر "مصروف" من شاشة دفتر اليومية (أو "إدارة المصروفات" من القائمة الجانبية).
    2.  تظهر نافذة `ExpenseForm.fxml`.
    3.  يُدخل المستخدم تاريخ المصروف، المبلغ، ويختار "نوع المصروف" من قائمة حسابات المصروفات، ويختار "حساب الدفع" (خزنة أو بنك)، ويكتب وصفًا للمصروف.
    4.  عند الحفظ، يستدعي `ExpenseFormController` خدمة `FinancialTransactionDataService.addExpense`.

*   **المنطق المحاسبي المتكامل (في `addExpense`):**
    تتم العملية أيضًا داخل معاملة متكاملة (`executeTransaction`) لضمان الدقة:
    1.  **تسجيل قيد اليومية:** يتم تسجيل قيد مزدوج في `general_ledger`:
        *   **مدين:** حساب المصروف المختار (مثل: مصروفات عمومية).
        *   **دائن:** حساب الدفع (الخزنة أو البنك).
    2.  **تحديث أرصدة الحسابات:** يتم تحديث رصيد كل من حساب المصروف وحساب الدفع.

*   **الملفات الرئيسية (للمصروفات):**
    *   **View:** `ExpenseManagement.fxml`, `ExpenseForm.fxml`
    *   **Controller:** `ExpenseManagementController.java`, `ExpenseFormController.java`
    *   **Service:** `FinancialTransactionDataService.java`

### 9.4. الوصول السريع للعمليات (Quick Actions)

يتميز دفتر اليومية بوجود أزرار وصول سريع في الأعلى (`فاتورة بيع`, `فاتورة شراء`, `مصروف`, `سند`) تتيح للمستخدم إنشاء أي نوع من العمليات مباشرة من هذه الشاشة المركزية، مما يحسن بشكل كبير من تجربة المستخدم وسرعة إدخال البيانات.

---

## 10. الوحدة الخامسة: التقارير المالية (Financial Reporting)

هذه الوحدة هي النتيجة النهائية لكل العمليات المسجلة في النظام. هي المسؤولة عن تجميع البيانات من دفتر الأستاذ العام (`general_ledger`) وتقديمها في شكل قوائم مالية معيارية تساعد المستخدم على فهم الأداء المالي والمركز المالي لنشاطه.

### 10.1. لوحة التقارير (Reports Dashboard)

*   **الغرض:** توفير نقطة انطلاق مركزية للمستخدم للوصول إلى جميع التقارير المالية المتاحة.
*   **الملفات:** `ReportsDashboard.fxml`, `ReportsDashboardController.java`
*   **تدفق المستخدم:** من القائمة الجانبية، يختار المستخدم "التقارير والتحليل" فتظهر له هذه الشاشة. تحتوي على بطاقات لكل تقرير رئيسي، يختار المستخدم التقرير المطلوب ويضغط على زر "إنشاء التقرير" لينتقل إلى شاشة التقرير المخصص.

### 10.2. ميزان المراجعة (Trial Balance)

*   **الغرض:** التأكد من صحة وتوازن القيود المحاسبية عن طريق التحقق من أن إجمالي الأرصدة المدينة يساوي إجمالي الأرصدة الدائنة لجميع الحسابات.
*   **الملفات:** `TrialBalanceView.fxml`, `TrialBalanceController.java`
*   **منطق العمل (`FinancialSummaryService.getTrialBalance`):**
    1.  يتم عمل استعلام (Query) على جدول `general_ledger`.
    2.  يتم تجميع (`GROUP BY`) القيود حسب رقم الحساب (`account_id`).
    3.  لكل حساب، يتم حساب مجموع كل من عمود المدين (`debit`) وعمود الدائن (`credit`).
    4.  يتم عرض النتائج في جدول، وفي النهاية يتم مقارنة الإجمالي. إذا كانا متساويين، يكون الميزان "متزن".

### 10.3. قائمة الدخل (Income Statement)

*   **الغرض:** قياس أداء النشاط خلال فترة زمنية محددة عن طريق مقارنة الإيرادات بالمصروفات للوصول إلى صافي الربح أو الخسارة.
*   **الملفات:** `IncomeStatementView.fxml`, `IncomeStatementController.java`
*   **منطق العمل (`FinancialSummaryService.getIncomeStatement`):**
    1.  يتم تحديد فترة التقرير (من تاريخ - إلى تاريخ).
    2.  يتم استعلام جدول `general_ledger` لجلب مجاميع الحسابات التي نوعها `REVENUE` خلال هذه الفترة.
    3.  يتم استعلام نفس الجدول مرة أخرى لجلب مجاميع الحسابات التي نوعها `EXPENSE` (بما في ذلك تكلفة البضاعة المباعة وخسائر المخزون).
    4.  يتم طرح إجمالي المصروفات من إجمالي الإيرادات للوصول إلى **صافي الدخل (Net Income)**.

### 10.4. الميزانية العمومية (Balance Sheet)

*   **الغرض:** تقديم صورة فوتوغرافية عن المركز المالي للنشاط في تاريخ محدد، من خلال عرض أصوله، التزاماته، وحقوق الملكية.
*   **الملفات:** `BalanceSheetView.fxml`, `BalanceSheetController.java`
*   **منطق العمل (`FinancialSummaryService.getBalanceSheet`):**
    1.  يتم تحديد تاريخ التقرير.
    2.  يتم استعلام `general_ledger` لجلب الأرصدة النهائية لجميع حسابات الأصول (`ASSET`, `CASH`, `BANK`, `ACCOUNTS_RECEIVABLE`, `CURRENT_ASSET`) حتى هذا التاريخ.
    3.  يتم جلب الأرصدة النهائية لجميع حسابات الخصوم (`LIABILITY`, `ACCOUNTS_PAYABLE`).
    4.  يتم جلب الأرصدة النهائية لجميع حسابات حقوق الملكية (`EQUITY`).
    5.  **نقطة الربط الهامة:** يتم استدعاء دالة `getIncomeStatement` لحساب **صافي الدخل** للفترة، والذي يضاف إلى حقوق الملكية تحت بند "الأرباح المحتجزة" أو "أرباح الفترة".
    6.  يتم التحقق من صحة المعادلة المحاسبية: **إجمالي الأصول = إجمالي الخصوم + إجمالي حقوق الملكية**.

### 10.5. العلاقة بين التقارير

التقارير ليست منفصلة، بل هي مترابطة بشكل وثيق:
1.  تبدأ الدورة المحاسبية بالقيود في **دفتر اليومية**.
2.  يتم تلخيص هذه القيود في **ميزان المراجعة** للتحقق من توازنها.
3.  تُستخدم حسابات الإيرادات والمصروفات من ميزان المراجعة لإنشاء **قائمة الدخل** وتحديد صافي الربح.
4.  يُستخدم صافي الربح هذا من قائمة الدخل لتحديث قسم حقوق الملكية في **الميزانية العمومية**، التي تستخدم بدورها أرصدة الحسابات الأصول والخصوم من ميزان المراجعة.

هذا الترابط يضمن أن النظام المحاسبي متكامل ويعكس صورة مالية دقيقة وموثوقة.

---

## 11. خاتمة

بهذا نكون قد أكملنا توثيق جميع الوحدات الرئيسية في نظام المحاسبة الزراعية، بدءًا من البيانات الأساسية، مرورًا بالعمليات اليومية والمخزون ودفتر اليومية، وانتهاءً بالتقارير المالية. أصبح هذا المستند الآن بمثابة خريطة طريق شاملة تساعد أي مطور على فهم بنية التطبيق، وتدفق البيانات، والمنطق المحاسبي المتكامل الذي يحكمه.